<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="../sidebar/style.css">
  </head>
  <body>
    <div id="overlay" class="overlay"></div>
    <aside id="sidebar" class="sidebar">
  <div class="frame">

    <!-- ìœ ì € ì˜ì—­ -->
    <div class="div">
      
      <div class="div-2">
        
      
      </div>
    </div>

    <div class="top-items-wrapper">
  <div class="top-items">

    <a href="../license/license.html" class="nav-link">
      <div class="menu-row">
        <img class="menu-icon" src="../sidebar/img/VectorDaily.svg" />
        <div class="menu-text">ìê²©ì¦ ë“±ë¡</div>
      </div>
    </a>

    <a href="../data/data.html" class="nav-link">
      <div class="menu-row">
        <img class="menu-icon" src="../sidebar/img/VectorData.svg" />
        <div class="menu-text">DATA</div>
      </div>
    </a>

    <a href="../diary/diary.html" class="nav-link">
      <div class="menu-row">
        <img class="menu-icon" src="../sidebar/img/VectorW.svg" />
        <div class="menu-text">ì¼ì§€ / ì¼ê¸° ê¸°ë¡ ê´€ë¦¬</div>
      </div>
    </a>

    <a href="../profile/profile.html" class="nav-link">
      <div class="menu-row">
        <img class="menu-icon" src="../sidebar/img/VectorProfile.svg" />
        <div class="menu-text">ë§ˆì´í˜ì´ì§€</div>
      </div>
    </a>

  </div>
</div>

      

    <!-- ì•„ë˜ ë©”ë‰´ -->
    <div class="bottom">
      <div class="bottom-icons">

        <a href="../settings/settings.html" class="nav-link">
          <div class="nav-text-item">
            <div class="content">
              <div class="vector-wrapper">
                <img class="vector" src="../sidebar/img/Settings.svg" />
              </div>
              <div class="label">Settings</div>
            </div>
          </div>
        </a>

        <a href="../login/login.html" class="nav-link" id="logoutBtn">
          <div class="nav-text-item">
            <div class="content">
              <div class="vector-wrapper">
                <img class="img" src="../sidebar/img/logout.svg" />
              </div>
              <div class="label">Logout</div>
            </div>
          </div>
        </a>

      </div>
    </div>

    <!-- ë¼ì¸/ì´ë¯¸ì§€ -->
    <img class="line" src="../sidebar/img/Line6.svg" />
    <img class="line-2" src="../sidebar/img/Line7.svg" />
  

  </div>
</aside>

    <div class="main">
      <div class="group">
        <div class="ellipse"></div>
        <div class="div"></div>
        <div class="ellipse-2"></div>
        <div class="ellipse-3"></div>
        <div class="ellipse-4"></div>
        <div class="ellipse-5"></div>
      </div>
      <div class="div-wrapper"><div class="hello" id="helloText">OOë‹˜ ì•ˆë…•í•˜ì„¸ìš”!</div></div>
      <img class="vuesax-bold" src="img/notification.svg" />
      <div class="frame-5">
        <div class="rectangle"></div>
        <div class="text-wrapper-11">ì§‘ì¤‘ë„</div>
        <img class="rectangle-2" src="img/Rectangle1037.svg" />
        <div class="text-wrapper-12">View</div>        
        <div class="text-wrapper-13" style="font-size: 2rem;top:3050px;left:250px">-</div>
      </div>
      <div class="frame-2">
        <div class="rectangle"></div>
        <div class="text-wrapper-2">ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜</div>
        <img class="rectangle-2" src="img/Rectangle1037.svg" />
        <div class="text-wrapper-3">View</div>
        <div class="text-wrapper-4" style="font-size: 2rem;top:3050px;left:250px">-</div>
      </div>

      <div class="frame-3 chart-month-wrap">
        <canvas id="monthChart" height="200"></canvas>
      </div>
      <img class="line" src="img/Line28.svg" />
      <div class="frame-4 chart-month-wrap">               
        <canvas id="focusChart" height="200"></canvas>
      </div>
      <div class="vuesax-bold-user-wrapper"></div>
      <div class="group-3">
        <img id="menuBtn" class="icon-menu-2" src="img/icon_menu.png" /> 
    </div>
    </div>
     

     <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bottom-bar">
    <nav class="bottom-nav">
      <a href="../data/data.html" class="nav-item">
        <img src="img/Group.png" alt="daily" />
      </a>

      <a href="../license/license.html" class="nav-item">
        <img src="img/calendar.png" alt="data" />
      </a>

      <a href="main.html" class="nav-item active">
        <img src="img/home.png" alt="home" />
      </a>

      <a href="../diary/diary.html" class="nav-item">
        <img src="img/document-text.png" alt="diary" />
      </a>

      <a href="../profile/profile.html" class="nav-item">
        <img src="img/profile-2user.png" alt="profile" />
      </a>
    </nav>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let focusChartInstance = null;
let stressChartInstance = null;

/* =========================
   ë‚ ì§œ â†’ ìš”ì¼
========================= */
function toWeekday(dateString) {
  const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const date = new Date(dateString); // â† í•µì‹¬
  if (isNaN(date)) return '';
  return days[date.getDay()];
}

/* =========================
   ë§ˆì§€ë§‰ ìœ íš¨ ìˆ«ì
========================= */
function lastValidNumber(arr) {
  for (let i = arr.length - 1; i >= 0; i--) {
    if (arr[i] !== null && arr[i] !== undefined) {
      return Number(arr[i]);
    }
  }
  return 0;
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸ”¥ main.html JS ì‹¤í–‰ë¨");

  const userNo = localStorage.getItem("user_no");
  if (!userNo) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
    location.href = "../login/login.html";
    return;
  }
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const menuBtn = document.getElementById("menuBtn");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const webcam = document.getElementById("webcam");

    if (!sidebar || !overlay || !menuBtn) {
      console.log("âŒ ì—°ê²° ì‹¤íŒ¨", { sidebar, overlay, menuBtn });
      return;
    }

    // ==============================
    // ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸°
    // ==============================
    menuBtn.addEventListener("click", () => {
      sidebar.classList.add("active");
      overlay.classList.add("active");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
    });


  fetch(`http://192.168.219.128:4000/api/dashboard/${userNo}`)
    .then(res => res.json())
    .then(data => {
      console.log("ğŸ“¦ API ì‘ë‹µ:", data);

      if (data.status !== "success") return;

      document.getElementById("helloText").innerText =
        `${data.name}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!`;

      const reports = data.reports;
      if (!reports || reports.length === 0) return;

      const labels = reports.map(r => toWeekday(r.report_date));
      const focusData = reports.map(r => r.avg_focus_score ?? 0);
      const stressData = reports.map(r => r.avg_stress_score ?? 0);

      console.log("ğŸ“Š focusData:", focusData);
      console.log("ğŸ“Š stressData:", stressData);
      console.log("ğŸ“Š labels:", labels);

      const todayFocus = Math.round(lastValidNumber(focusData));
      const todayStress = Math.round(lastValidNumber(stressData));

      document.querySelector(".text-wrapper-13").innerText = `${todayFocus}%`;
      document.querySelector(".text-wrapper-4").innerText = `${todayStress}%`;

      drawBarChart(
        "monthChart",
        labels,
        focusData,
        "#33D6A6",
        c => focusChartInstance = c
      );

      drawBarChart(
        "focusChart",
        labels,
        stressData,
        "#FF8A8A",
        c => stressChartInstance = c
      );
    });
});

/* =========================
   ê³µí†µ ì°¨íŠ¸ í•¨ìˆ˜
========================= */
function drawBarChart(canvasId, labels, data, color, setInstance) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) {
    console.error("âŒ canvas ì—†ìŒ:", canvasId);
    return;
  }

  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: color,
        borderRadius: 12,
        barThickness: 12
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, ticks: { stepSize: 50 } }
      }
    }
  });

  setInstance(chart);
}
</script>

  </body>
</html>
